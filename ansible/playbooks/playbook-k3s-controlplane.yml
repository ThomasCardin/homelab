---
- name: Setup k3s control plane
  hosts: controlplane
  become: true

  tasks:
    - name: Include variables (variables.yml)
      ansible.builtin.include_vars: ../variables.yml

    - name: Update the apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install iptables
      ansible.builtin.apt:
        name: iptables
        state: present

    - name: Install k3s
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s_install_script.sh
        mode: "0755"

    - name: Set environment variable for k3s installation
      ansible.builtin.shell:
        cmd: >
          export INSTALL_K3S_EXEC=server
      register: k3s_env_output
      changed_when: k3s_env_output.rc != 0

    - name: Run k3s installation script
      ansible.builtin.shell:
        cmd: >
          /tmp/k3s_install_script.sh
          --flannel-backend none
          --disable-network-policy
          --disable-cloud-controller
          --write-kubeconfig-mode 644
          --disable servicelb
          --disable traefik
          --disable metrics-server
          --disable kube-proxy
          --token {{ k3s_token }}
      register: k3s_install_output
      changed_when: k3s_install_output.rc != 0

    # not best pratice for a k8s controlplane node
    - name: Label kubernetes controlplane node
      ansible.builtin.command:
        cmd: >
          kubectl label nodes controlplane kubernetes.io/role=worker
      register: kubectl_label_controlplane_output
      changed_when: kubectl_label_controlplane_output.rc != 0

    - name: Label kubernetes worker1 node
      ansible.builtin.command:
        cmd: >
          kubectl label nodes worker1 kubernetes.io/role=worker
      register: kubectl_label_worker_1_output
      changed_when: kubectl_label_worker_1_output.rc != 0

    - name: Label kubernetes worker2 node
      ansible.builtin.command:
        cmd: >
          kubectl label nodes worker2 kubernetes.io/role=worker
      register: kubectl_label_worker_2_output
      changed_when: kubectl_label_worker_2_output.rc != 0

    - name: Label kubernetes worker3 node
      ansible.builtin.command:
        cmd: >
          kubectl label nodes worker3 kubernetes.io/role=worker
      register: kubectl_label_worker_3_output
      changed_when: kubectl_label_worker_3_output.rc != 0

    # not best pratice for a k8s controlplane node
    - name: Set kubernetes controlplane nodes type
      ansible.builtin.command:
        cmd: >
          kubectl label nodes controlplane node-type=worker
      register: kubectl_controlplane_node_type
      changed_when: kubectl_controlplane_node_type.rc != 0

    - name: Set kubernetes worker1 nodes type
      ansible.builtin.command:
        cmd: >
          kubectl label nodes worker1 node-type=worker
      register: kubectl_worker1_node_type
      changed_when: kubectl_worker1_node_type.rc != 0

    - name: Set kubernetes worker2 nodes type
      ansible.builtin.command:
        cmd: >
          kubectl label nodes worker2 node-type=worker
      register: kubectl_worker2_node_type
      changed_when: kubectl_worker2_node_type.rc != 0

    - name: Set kubernetes worker3 nodes type
      ansible.builtin.command:
        cmd: >
          kubectl label nodes worker3 node-type=worker
      register: kubectl_worker3_node_type
      changed_when: kubectl_worker3_node_type.rc != 0
